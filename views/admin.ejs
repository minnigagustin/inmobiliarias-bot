<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Agentes | BR-Group</title>
  <style>
    :root {
      --bg-dark: #0f172a;
      --bg-darker: #020617;
      --accent: #22d3ee;
      --accent-hover: #06b6d4;
      --danger: #ef4444;
      --success: #10b981;
      --text: #f8fafc;
      --text-dim: #94a3b8;
      --glass: rgba(30, 41, 59, 0.75);
      --glass-light: rgba(255, 255, 255, 0.05);
      --border: rgba(255, 255, 255, 0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }

    body {
      height: 100vh;
      background-color: var(--bg-darker);
      color: var(--text);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Fondo animado (Igual que login) */
    .bg-shapes { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
    .shape { position: absolute; filter: blur(100px); opacity: 0.4; animation: float 10s infinite ease-in-out; }
    .s1 { top: -10%; left: -10%; width: 40vw; height: 40vw; background: radial-gradient(circle, #4f46e5 0%, transparent 70%); }
    .s2 { bottom: -10%; right: -10%; width: 30vw; height: 30vw; background: radial-gradient(circle, #0ea5e9 0%, transparent 70%); }
    @keyframes float { 0%,100%{transform:translate(0,0)} 50%{transform:translate(20px,30px)} }

    /* Layout Principal */
    .dashboard {
      display: grid;
      grid-template-columns: 350px 1fr;
      height: 100%;
      gap: 1px;
      background: var(--border); /* L√≠nea separadora */
    }

    /* --- SIDEBAR (Cola) --- */
    .sidebar {
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
    }

    .header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .agent-info h2 { font-size: 1.1rem; font-weight: 700; color: var(--text); }
    .agent-info span { font-size: 0.8rem; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }

    .btn-logout {
      padding: 6px 12px;
      font-size: 0.8rem;
      color: var(--text-dim);
      border: 1px solid var(--border);
      border-radius: 6px;
      text-decoration: none;
      transition: 0.2s;
    }
    .btn-logout:hover { background: rgba(255,255,255,0.1); color: #fff; }

    .queue-title {
      padding: 15px 20px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      background: rgba(0,0,0,0.2);
    }

    .queue-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .queue-card {
      background: var(--glass-light);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      transition: 0.2s;
      animation: fadeIn 0.3s ease;
    }
    .queue-card:hover { border-color: var(--accent); background: rgba(34, 211, 238, 0.05); }
    @keyframes fadeIn { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }

    .q-time { font-size: 0.75rem; color: var(--text-dim); display: block; margin-bottom: 4px; }
    .q-reason { font-weight: 600; font-size: 0.95rem; display: block; margin-bottom: 8px; color: #fff; }
    .btn-take {
      width: 100%;
      padding: 8px;
      background: var(--success);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .btn-take:hover { filter: brightness(1.1); }

    /* --- MAIN CHAT AREA --- */
    .chat-area {
      background: rgba(2, 6, 23, 0.6);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Estado vac√≠o */
    #empty-state {
      position: absolute; top:0; left:0; width:100%; height:100%;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      color: var(--text-dim);
      z-index: 10;
      background: var(--bg-darker);
    }
    #empty-state svg { width: 64px; height: 64px; margin-bottom: 1rem; opacity: 0.5; }

    /* Chat Activo */
    #active-chat { display: none; flex-direction: column; height: 100%; }

    .chat-header {
      padding: 15px 20px;
      background: var(--glass);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-user { font-weight: 700; font-size: 1.1rem; }
    .btn-finish {
      background: var(--danger);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: flex; align-items: center; gap: 6px;
    }
    .btn-finish:hover { filter: brightness(1.1); }

    /* Detalles del caso (Info extra) */
    .case-info {
      background: rgba(34, 211, 238, 0.05);
      border-bottom: 1px solid var(--border);
      padding: 10px 20px;
      font-size: 0.9rem;
      display: none; /* Se activa con JS */
    }
    .case-row { margin-bottom: 4px; display: flex; gap: 8px; }
    .case-label { color: var(--accent); font-weight: 600; min-width: 80px; }
    .case-val { color: var(--text-dim); }
    .case-photos { display: flex; gap: 8px; margin-top: 8px; overflow-x: auto; padding-bottom: 4px; }
    .case-thumb { height: 60px; border-radius: 6px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
    .case-thumb:hover { transform: scale(1.05); border-color: var(--accent); }

    /* Hilo de mensajes */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .msg { max-width: 70%; padding: 10px 14px; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; position: relative; animation: popIn 0.2s cubic-bezier(0.17, 0.84, 0.44, 1); }
    @keyframes popIn { from{transform:scale(0.9); opacity:0} to{transform:scale(1); opacity:1} }

    .msg.user { align-self: flex-start; background: #1e293b; color: #fff; border-bottom-left-radius: 2px; }
    .msg.agent { align-self: flex-end; background: #0891b2; color: #fff; border-bottom-right-radius: 2px; }
    .msg.bot { align-self: center; background: transparent; border: 1px solid var(--border); color: var(--text-dim); font-size: 0.85rem; max-width: 90%; }
    .msg.system { align-self: center; color: var(--accent); font-size: 0.8rem; font-weight: 600; background: rgba(34,211,238,0.1); padding: 4px 12px; border-radius: 99px; }
    
    .msg-meta { font-size: 0.7rem; opacity: 0.6; margin-top: 4px; display: block; text-align: right; }

    /* Input Area */
    .input-area {
      padding: 20px;
      background: var(--glass);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }
    #chatInput {
      flex: 1;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 16px;
      color: #fff;
      outline: none;
    }
    #chatInput:focus { border-color: var(--accent); }
    #sendBtn {
      background: var(--accent);
      color: #0f172a;
      border: none;
      padding: 0 20px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
    }
    #sendBtn:hover { filter: brightness(1.1); }

  </style>
</head>
<body>

  <div class="bg-shapes">
    <div class="shape s1"></div>
    <div class="shape s2"></div>
  </div>

  <div class="dashboard">
    <div class="sidebar">
      <div class="header">
        <div class="agent-info">
          <h2><%= agentName %></h2>
          <span>En L√≠nea ‚óè</span>
        </div>
        <a href="/logout" class="btn-logout">Salir</a>
      </div>
      
      <div class="queue-title">Cola de Espera</div>
      <div id="queue-list" class="queue-list">
        <div style="text-align:center; color:var(--text-dim); font-size:0.9rem; margin-top:20px;">
          No hay chats en espera.
        </div>
      </div>
    </div>

    <div class="chat-area">
      
      <div id="empty-state">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
        <p>Seleccion√° un chat de la cola para comenzar</p>
      </div>

      <div id="active-chat">
        <div class="chat-header">
          <div class="chat-user" id="chat-title">Usuario</div>
          <button id="finishBtn" class="btn-finish">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right:4px"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            Finalizar
          </button>
        </div>

        <div id="case-details" class="case-info"></div>

        <div id="thread" class="messages"></div>

        <div class="input-area">
          <input type="text" id="chatInput" placeholder="Escrib√≠ tu mensaje..." autocomplete="off">
          <button id="sendBtn">Enviar</button>
        </div>
      </div>

    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io('/admin');
    let currentChatId = null;

    // Elementos DOM
    const queueList = document.getElementById('queue-list');
    const emptyState = document.getElementById('empty-state');
    const activeChat = document.getElementById('active-chat');
    const thread = document.getElementById('thread');
    const caseDetails = document.getElementById('case-details');
    const chatTitle = document.getElementById('chat-title');
    const input = document.getElementById('chatInput');

    // --- SOCKET LOGIC ---

    socket.on('connect_error', () => window.location.href = '/login');

    socket.on('queue_snapshot', (list) => {
      queueList.innerHTML = '';
      if(list.length === 0) {
        queueList.innerHTML = `<div style="text-align:center; color:#94a3b8; font-size:0.9rem; margin-top:20px;">No hay chats en espera.</div>`;
        return;
      }
      list.forEach(renderQueueItem);
    });

    socket.on('queue_add', (rec) => {
      // Si dice "no hay chats", limpiarlo primero
      if(queueList.innerText.includes('No hay chats')) queueList.innerHTML = '';
      renderQueueItem(rec);
    });

    socket.on('queue_remove', ({chatId}) => {
      const el = document.getElementById(`q-${chatId}`);
      if(el) {
        el.style.opacity = '0';
        setTimeout(() => el.remove(), 300);
      }
    });

    socket.on('assigned', ({ chatId, transcript, payload }) => {
      // Activar UI
      emptyState.style.display = 'none';
      activeChat.style.display = 'flex';
      
      currentChatId = chatId;
      chatTitle.innerText = chatId;
      
      // Render Case Details (Payload)
      renderCaseInfo(payload);

      // Render History
      thread.innerHTML = '';
      transcript.forEach(renderMessage);
      scrollToBottom();

      input.focus();
    });

    socket.on('chat_message', (msg) => {
      if(msg.chatId === currentChatId) {
        renderMessage(msg);
        scrollToBottom();
      }
    });

    // --- RENDERING HELPERS ---

    function renderQueueItem(rec) {
      const div = document.createElement('div');
      div.className = 'queue-card';
      div.id = `q-${rec.chatId}`;
      div.innerHTML = `
        <span class="q-time">Hace un momento</span>
        <span class="q-reason">${getReasonText(rec.payload)}</span>
        <span class="q-time">ID: ${rec.chatId}</span>
        <button class="btn-take" onclick="takeChat('${rec.chatId}')">Tomar Chat</button>
      `;
      queueList.appendChild(div);
    }

    function renderMessage(msg) {
      const div = document.createElement('div');
      // Clases: user, agent, bot, system
      div.className = `msg ${msg.who}`;

      let content = msg.text || '';
      
      // Si es imagen
      if(msg.type === 'image') {
        content = `<a href="${msg.url}" target="_blank"><img src="${msg.url}" style="max-width:200px; border-radius:8px; display:block;"></a>`;
      }
      
      div.innerHTML = `
        ${content}
        <span class="msg-meta">${new Date(msg.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
      `;
      
      thread.appendChild(div);
    }

    function renderCaseInfo(p) {
      caseDetails.style.display = 'none';
      caseDetails.innerHTML = '';
      
      if(!p) return;

      let html = '';
      
      // Mantenimiento
      if(p.categoria) {
        html += row('üõ† Categor√≠a', p.categoria);
        html += row('üìç Direcci√≥n', p.direccion);
        html += row('üìù Descripci√≥n', p.descripcion);
        if(p.fotos && p.fotos.length) {
          html += `<div class="case-photos">
            ${p.fotos.map(url => `<a href="${url}" target="_blank"><img src="${url}" class="case-thumb"></a>`).join('')}
          </div>`;
        }
      }
      // Propiedades
      else if(p.propform) {
        html += row('üè† Operaci√≥n', `${p.propform.op} ${p.propform.tipo}`);
        html += row('üìç Zona', p.propform.city || p.propform.direccion);
        html += row('üí∞ Presupuesto', `${p.propform.moneda || '$'} ${p.propform.presupuesto || '-'}`);
        html += row('üõè Detalle', `${p.propform.dorm||0} Dorm / ${p.propform.banos||0} Ba√±os`);
      }
      // √çndice
      else if(p.indice) {
        html += row('üìà √çndice', p.indice);
        html += row('üßÆ C√°lculo', p.calculo);
      }
      // Motivo simple
      else if(p.motivo) {
        html += row('‚ÑπÔ∏è Motivo', p.motivo);
      }

      if(html) {
        caseDetails.innerHTML = html;
        caseDetails.style.display = 'block';
      }
    }

    function row(label, val) {
      if(!val) return '';
      return `<div class="case-row"><span class="case-label">${label}:</span> <span class="case-val">${val}</span></div>`;
    }

    function getReasonText(p) {
      if(!p) return 'Consulta General';
      if(p.categoria) return `üõ† ${p.categoria}`;
      if(p.propform) return `üè† ${p.propform.op} ${p.propform.tipo}`;
      if(p.indice) return `üìà ${p.indice}`;
      return p.motivo || 'Consulta';
    }

    function scrollToBottom() {
      thread.scrollTop = thread.scrollHeight;
    }

    // --- ACTIONS ---

    window.takeChat = (chatId) => {
      socket.emit('assign', { chatId });
    };

    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    input.addEventListener('keypress', (e) => {
      if(e.key === 'Enter') sendMessage();
    });

    function sendMessage() {
      const text = input.value.trim();
      if(!text || !currentChatId) return;
      socket.emit('agent_message', { chatId: currentChatId, text });
      input.value = '';
    }

    document.getElementById('finishBtn').addEventListener('click', () => {
      if(!currentChatId) return;
      if(confirm('¬øFinalizar esta conversaci√≥n? El bot volver√° a tomar el control.')) {
        socket.emit('finish', { chatId: currentChatId });
        
        // Reset UI
        activeChat.style.display = 'none';
        emptyState.style.display = 'flex';
        currentChatId = null;
      }
    });

  </script>
</body>
</html>