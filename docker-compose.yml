# ===========================================
# BR-Group WhatsApp Bot - Docker Compose
# ===========================================

version: '3.8'

services:
  # Web Server + Bot
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: br-whatsapp-web
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - SESSION_SECRET=${SESSION_SECRET}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - BRIDGE_URL=http://localhost:3000/bridge
      - AGENT_NUMBER=${AGENT_NUMBER:-}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}
      - WP_BASE=${WP_BASE:-https://lginmobiliaria.com.ar}
      - COMPANY_NAME=${COMPANY_NAME:-BR-Group}
      - BOT_NAME=${BOT_NAME:-asistente virtual}
    volumes:
      # Persist WhatsApp session
      - whatsapp_session:/app/.wwebjs_auth
      # Persist database
      - ./chat.db:/app/chat.db
      - ./sessions.db:/app/sessions.db
      # Persist uploads
      - ./public/uploads:/app/public/uploads
      # Persist logs
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - br-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # WhatsApp Client (separate container for WhatsApp connection)
  whatsapp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: br-whatsapp-client
    restart: unless-stopped
    command: ["node", "index.js"]
    environment:
      - NODE_ENV=production
      - BRIDGE_URL=http://web:3000/bridge
      - AGENT_NUMBER=${AGENT_NUMBER:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - whatsapp_session:/app/.wwebjs_auth
    depends_on:
      web:
        condition: service_healthy
    networks:
      - br-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

volumes:
  whatsapp_session:
    driver: local

networks:
  br-network:
    driver: bridge
